# Referencia de Configuración de WiloDev Dock

## Overview

This document provides a comprehensive guide to configuring WiloDev Dock, explaining all available settings, environment variables, and customization options. Whether you need to adjust database settings, modify proxy behavior, or customize monitoring solutions, you'll find detailed instructions here.

## Tabla de Contenidos

- [Environment Variables](#environment-variables)
- [Traefik Configuration](#traefik-configuration)
- [Database Configuration](#database-configuration)
- [SSL/HTTPS Configuration](#sslhttps-configuration)
- [Middleware Configuration](#middleware-configuration)
- [Monitoring Configuration](#monitoring-configuration)
- [Custom Network Configuration](#custom-network-configuration)
- [Advanced Customization](#advanced-customization)

## Environment Variables

The `.env` file is the central configuration file for WiloDev Dock. Here's a breakdown of all available variables:

### Base Configuration (.env)

```bash
# Base domain for all services (e.g., 'myapp.localhost')
DOMAIN_BASE=wilodev.localhost

# Docker network name
NETWORK_NAME=wilodev_network
```

### Container Names (.env)

```bash
# Names for all service containers - change if you need multiple installations
TRAEFIK_CONTAINER_NAME=wilodev-traefik
MYSQL_CONTAINER_NAME=wilodev-mysql
MONGO_CONTAINER_NAME=wilodev-mongo
MAILHOG_CONTAINER_NAME=wilodev-mailhog
PROMETHEUS_CONTAINER_NAME=wilodev-prometheus
GRAFANA_CONTAINER_NAME=wilodev-grafana
LOKI_CONTAINER_NAME=wilodev-loki
PROMTAIL_CONTAINER_NAME=wilodev-promtail
```

### Service Subdomains (.env)

```bash
# Subdomains for various services
TRAEFIK_SUBDOMAIN=traefik
MAILHOG_SUBDOMAIN=mail
```

### Service Versions (.env)

```bash
# Software versions - update as needed, but be aware of potential compatibility issues
PHP_VERSION=8.3
MYSQL_VERSION=8.0
MONGO_VERSION=7.0
NODE_VERSION=20
TRAEFIK_VERSION=v3.3.4
PROMETHEUS_VERSION=v2.45.0
GRAFANA_VERSION=10.1.0
LOKI_VERSION=2.9.0
PROMTAIL_VERSION=2.9.0
```

### Service Ports (.env)

```bash
# Ports for external access - change if you have port conflicts
TRAEFIK_HTTP_PORT=80
TRAEFIK_HTTPS_PORT=443
MYSQL_PORT=3306
MONGO_PORT=27017
MAILHOG_SMTP_PORT=1025
MAILHOG_HTTP_PORT=8025
```

### MySQL Configuration (.env)

```bash
# MySQL credentials and database name
MYSQL_ROOT_PASSWORD=rootpassword
MYSQL_DATABASE=app
MYSQL_USER=appuser
MYSQL_PASSWORD=apppassword
```

### MongoDB Configuration (.env)

```bash
# MongoDB credentials and database name
MONGO_INITDB_ROOT_USERNAME=root
MONGO_INITDB_ROOT_PASSWORD=rootpassword
MONGO_INITDB_DATABASE=app
```

### Traefik Configuration (.env)

```bash
# Traefik dashboard credentials
TRAEFIK_DASHBOARD_USER=admin
TRAEFIK_DASHBOARD_PASSWORD=admin123
TRAEFIK_DASHBOARD_AUTH=admin:$apr1$xyz...123  # Generated by setup.sh

# SSL certificate paths
SSL_CERT_PATH=./traefik/config/certs/cert.pem
SSL_KEY_PATH=./traefik/config/certs/key.pem

# Dashboard settings
TRAEFIK_DASHBOARD_ENABLED=true
TRAEFIK_API_INSECURE=false
TRAEFIK_LOG_LEVEL=INFO
TRAEFIK_ACCESS_LOG_ENABLED=true
TRAEFIK_DASHBOARD_ROUTER_NAME=traefik-dashboard

# SSL
TRAEFIK_ACME_EMAIL=admin@example.com
TRAEFIK_SSL_RESOLVER=mkcert
```

### Middleware Configuration(.env)

```bash
# Middleware names - change only if you need to avoid name conflicts
AUTH_MIDDLEWARE_NAME=auth-basic
COMPRESS_MIDDLEWARE_NAME=compress
SECURITY_HEADERS_MIDDLEWARE_NAME=secure-headers
RATE_LIMIT_MIDDLEWARE_NAME=rate-limit
HTTPS_REDIRECT_MIDDLEWARE_NAME=https-redirect
CORS_MIDDLEWARE_NAME=cors
PATH_REWRITE_MIDDLEWARE_NAME=path-rewrite
TIMEOUT_MIDDLEWARE_NAME=timeout

# Security settings
AUTH_REALM=Secured Area
HSTS_SECONDS=31536000
HSTS_INCLUDE_SUBDOMAINS=true
HSTS_PRELOAD=true
FRAME_OPTIONS_VALUE=SAMEORIGIN
XSS_FILTER=true
REFERRER_POLICY=strict-origin-when-cross-origin
FEATURE_POLICY=camera 'none'; microphone 'none'; geolocation 'none'
PERMISSIONS_POLICY=camera=(), microphone=(), geolocation=()

# HTTPS configuration
HTTPS_REDIRECT_PERMANENT=true
HTTPS_PORT=443

# Rate limiting settings
RATE_LIMIT_AVERAGE=100
RATE_LIMIT_PERIOD=1s
RATE_LIMIT_BURST=50

# CORS settings
CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,OPTIONS
CORS_ALLOWED_HEADERS=Content-Type,Authorization,X-Requested-With
CORS_MAX_AGE=600
CORS_ALLOW_CREDENTIALS=true
ADDITIONAL_ALLOWED_ORIGINS=https://app.example.com

# Path rewrite
STRIP_PREFIX_PATH=/api

# Auth service configuration
AUTH_SERVICE_HOST=auth-service
AUTH_SERVICE_PORT=8080
```

### Network Configuration

```bash
# Trusted IPs (comma-separated) for admin access
TRAEFIK_TRUSTED_IPS=127.0.0.1/32,10.0.0.0/8
```

### Monitoring Configuration

```bash
# Enable/disable monitoring services
PROMETHEUS_ENABLED=true
GRAFANA_ENABLED=true
LOKI_ENABLED=true

# Grafana admin credentials
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=admin123
```

## Traefik Configuration

Traefik is the core reverse proxy used in WiloDev Dock, handling all HTTP/HTTPS traffic, routing, and SSL termination.

### Main Configuration File

The main Traefik configuration file is located at `traefik/config/traefik.yml`. Key settings include:

- `api`: Controls the Traefik dashboard
- `entryPoints`: Defines HTTP and HTTPS entry points
- `providers`: Configures how Traefik discovers services
- `certificatesResolvers`: Configures SSL certificate handling
- `log`: Controls logging behavior

Example customizations:

```yaml
# Enable debug mode for troubleshooting
api:
  dashboard: true
  debug: true

# Change the HTTP port
entryPoints:
  web:
    address: ":8080"
    
# Adjust log level for more verbosity
log:
  level: DEBUG
```

### Dynamic Configuration

The dynamic configuration file in `traefik/config/dynamic.yml` contains settings that can be updated without restarting Traefik:

- `tls`: SSL/TLS configuration and certificates
- `http.routers`: Specific routing rules
- `http.services`: Backend service definitions

Example customizations:

```yaml
# Add a new service
http:
  services:
    mi-api-personalizada:
      loadBalancer:
        servers:
          - url: "http://mi-contenedor-api:8080"
```

### Middleware Configuration

The middleware configuration file in `traefik/config/middleware.yml` defines all middleware components:

- Authentication
- Compression
- Security headers
- Rate limiting
- CORS
- Path rewrite

Example customizations:

```yaml
# Add a custom middleware
http:
  middlewares:
    mi-middleware-personalizado:
      headers:
        customResponseHeaders:
          X-Cabecera-Personalizada: "Valor Personalizado"
```

## Database Configuration

### MySQL Configuration

MySQL configuration can be customized in two ways:

1. **Environment Variables**: Set values in `.env` for basic configuration
2. **Custom Configuration File**: Edit `mysql/config/my.cnf` for advanced configurations

Common MySQL optimizations:

```ini
[mysqld]
# Increase buffer pool size for better performance
innodb_buffer_pool_size = 256M

# Improve write performance
innodb_flush_log_at_trx_commit = 2

# Query cache configuration
query_cache_size = 32M
query_cache_limit = 2M
```

### MongoDB Configuration

MongoDB configuration can be customized in:

1. **Environment Variables**: Set values in `.env` for basic configuration
2. **Custom Configuration File**: Edit `mongo/config/mongod.conf` for advanced configurations

Common MongoDB optimizations:

```yaml
storage:
  wiredTiger:
    engineConfig:
      cacheSizeGB: 1
systemLog:
  verbosity: 0
```

## SSL/HTTPS Configuration

WiloDev Dock uses locally trusted SSL certificates generated with `mkcert`. Configuration occurs automatically during initial setup.

### SSL Certificate Paths

```bash
SSL_CERT_PATH=./traefik/config/certs/cert.pem
SSL_KEY_PATH=./traefik/config/certs/key.pem
```

### Regenerating Certificates

If you need to regenerate certificates or add additional domains:

```bash
cd traefik/config/certs
mkcert -cert-file cert.pem -key-file key.pem "*.wilodev.localhost" "wilodev.localhost" "additional-domain.localhost"
```

### Advanced TLS Configuration

Advanced TLS configuration can be customized in `traefik/config/dynamic.yml`:

```yaml
tls:
  options:
    default:
      minVersion: "ТLS1.3"
      sniStrict: true
      cipherSuites:
        - "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
```

### Middleware Config

Traefik middlewares can be customized in `traefik/config/middleware.yml`. Key middlewares include:

### Security Headers

```yaml
secureHeaders:
  headers:
    forceSTSHeader: true
    stsSeconds: 31536000
    stsIncludeSubdomains: true
    contentSecurityPolicy: "default-src 'self'"
```

### Rate Limiting

```yaml
rateLimit:
  rateLimit:
    average: 100
    period: 1s
    burst: 50
```

### CORS

```yaml
cors:
headers:
  accessControlAllowMethods:
    - "GET"
    - "POST"
    - "PUT"
    - "DELETE"
    - "OPTIONS"
  accessControlAllowOriginList:
    - "https://*.example.com"
  accessControlMaxAge: 600
  accessControlAllowCredentials: true
```

### Monitoring Configuration yaml

WiloDev Dock includes a comprehensive monitoring stack with Prometheus, Grafana, and Loki.

### Prometheus Configuration

The Prometheus configuration file is at `prometheus/prometheus.yml`. Key settings include:

- `scrape_interval`: How often to collect metrics
- `scrape_configs`: Which targets to monitor

Example customization:

```yaml
global:
  scrape_interval: 30s  # Collect metrics every 30 seconds

scrape_configs:
  - job_name: 'my-custom-app'
    static_configs:
      - targets: ['my-app:9090']
```

### Grafana Configuration

Grafana is configured through environment variables and provisioning files in `grafana/provisioning/`:

- `datasources`: Configures data sources like Prometheus and Loki
- `dashboards`: Configures Grafana dashboards

You can add custom dashboards by placing JSON files in `grafana/provisioning/dashboards/`.

### Loki Configuration

Loki is configured in `loki/config.yml`. You can adjust:

- `retention_period`: How long to keep logs
- `chunk_size`: Performance tuning for log storage

### Custom Network Configuration

The Docker network is defined in the `docker-compose.yml` file:

```yaml
networks:
${NETWORK_NAME}:
  name: ${NETWORK_NAME}
  driver: bridge
```

To customize network settings:

1. Edit the `.env` file to change `NETWORK_NAME`
2. Add subnet configuration if needed:

```yaml
networks:
${NETWORK_NAME}:
  name: ${NETWORK_NAME}
  driver: bridge
  ipam:
    config:
      - subnet: 172.28.0.0/16
```

### Advanced Customization

#### Adding Custom Services

To add a custom service to WiloDev Dock:

1. Add the service to `docker-compose.yml`:

   ```yaml
    my-custom-service:
      container_name: my-custom-service
      image: my-custom-image:latest
      restart: unless-stopped
      networks:
        - ${NETWORK_NAME}
      volumes:
        - ./my-custom-data:/var/data
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.my-service.rule=Host(`my-service.${DOMAIN_BASE}`)"
        - "traefik.http.routers.my-service.entrypoints=websecure"
        - "traefik.http.routers.my-service.tls=true"
        - "traefik.http.services.my-service.loadbalancer.server.port=8080"
   ```

2. Update `.env` with any required environment variables
3. Start the service: `docker-compose up -d my-custom-service`

#### Customizing Docker Logging

You can customize Docker logging for all services by adding:

```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

#### Persistent Storage Optimization

For better performance or data management:

```yaml
volumes:
mysql_data:
  name: ${MYSQL_CONTAINER_NAME}-data
  driver: local
  driver_opts:
    type: none
    o: bind
    device: /path/to/custom/storage
```

## Troubleshooting Configuration Issues

### Common Configuration Problems

#### SSL Certificate Issues

If you encounter SSL certificate errors:

1. Ensure mkcert is properly installed:

   ```bash
   mkcert -install
   ```

2. Regenerate certificates:

   ```bash
   cd traefik/config/certs
   mkcert -cert-file cert.pem -key-file key.pem "*.${DOMAIN_BASE}" "${DOMAIN_BASE}"
   ```

3. Verify certificate paths in `.env` match the actual files
4. Restart Traefik:

   ```bash
   docker-compose restart traefik
   ```

#### Network Connectivity Issues

If services can't communicate:

1. Verify all services are on the same network:

   ```bash
   docker network inspect ${NETWORK_NAME}
   ```

2. Check for overlapping network configurations
3. Try recreating the network:

   ```bash
   docker-compose down
   docker network rm ${NETWORK_NAME}
   docker-compose up -d
   ```

#### Database Connection Problems

If projects can't connect to databases:

1. Verify database credentials in `.env`
2. Check if database containers are running:
  
   ```bash
   docker-compose ps mysql mongodb
   ```

3. Test connection directly:

   ```bash
   docker exec -it ${MYSQL_CONTAINER_NAME} mysql -u ${MYSQL_USER} -p${MYSQL_PASSWORD}
   ```

#### Performance Issues

If you experience slowness in the environment:

1. Monitor resource usage:

    ```bash
    docker stats
    ```

2. Adjust memory limits in `docker-compose.yml`:
  
    ```yaml
      services:
        mysql:
          mem_limit: 512m
    ```

3. Optimize database configurations as described earlier
4. Consider disabling services you don't need:

    ```bash
    docker-compose stop prometheus grafana loki promtail
    ```

#### Traefik Dashboard Issues

If you can't access the Traefik dashboard:

1. Check if Traefik is running:

    ```bash
    docker-compose ps traefik
    ```

2. Check credentials in `.env`:
  
    ```yaml
      services:
        mysql:
          mem_limit: 512m
    ```

3. Check if authentication middleware is configured correctly
4. Check Traefik logs:

    ```bash
    docker-compose logs traefik
    ```

### Additional Resources

- [Official Traefik documentation](https://doc.traefik.io/traefik/)
- [Docker Compose documentation](https://docs.docker.com/compose/)
- [MySQL documentation](https://docs.mysql.com/)
- [MongoDB documentation](https://docs.mongodb.com/)
- [Prometheus documentation](https://prometheus.io/docs/introduction/overview/)
- [Grafana documentation](https://grafana.com/docs/grafana/latest/)
- [Loki documentation](https://grafana.com/docs/loki/latest/)

### Conclusion

This configuration guide provides a comprehensive reference for customizing and optimizing your WiloDev Dock environment. From basic settings to advanced configurations, you now have the tools to tailor the environment to your specific development needs.

Remember that most configuration changes require restarting affected services or, in some cases, restarting the entire environment to apply all configurations correctly.
